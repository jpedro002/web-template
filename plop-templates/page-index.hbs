import { Edit, Loader2, Trash2 } from 'lucide-react'
import { useMemo } from 'react'
import { Helmet } from 'react-helmet-async'
import { useNavigate, useSearchParams } from 'react-router'
import { DeleteConfirmDialog } from 'src/components/delete-confirm-dialog'
import { PermissionRoute } from 'src/components/protected-route'
import { GenericTable } from 'src/components/table/table'
import {
	Card,
	CardContent,
	CardDescription,
	CardHeader,
	CardTitle,
} from 'src/components/ui/card'
import { useDeleteWithConfirmation } from 'src/hooks/use-delete-with-confirmation'
import { useHeaderConfig } from 'src/hooks/use-header-config'
import { useTableStateFromUrl } from 'src/hooks/use-table-state-from-url'
import { toast } from 'src/lib/toast'
import { use{{entityPascal}}Delete, use{{entityPascal}}List } from 'src/services/{{entityPlural}}'

const {{entityPascal}}Page = () => {
	const navigate = useNavigate()
	const [searchParams] = useSearchParams()
	const query = searchParams.get('q') || ''

	// üöÄ Hook para sincronizar pagina√ß√£o com a URL (usado para a query da API)
	const { page, pageSize } = useTableStateFromUrl({ defaultPageSize: 20 })

	const {
		data: {{entityPluralCamel}}Data,
		isLoading,
		isFetching,
	} = use{{entityPascal}}List({
		page,
		pageSize,
		term: query,
		fields: ['title'], // TODO: Ajustar campos de busca
	})

	const deleteMutation = use{{entityPascal}}Delete()

	const deleteConfirmation = useDeleteWithConfirmation(deleteMutation, {
		title: 'Excluir {{entityPascal}}',
		getDescription: (item) =>
			`Tem certeza que deseja excluir "${item.title}"? Esta a√ß√£o n√£o pode ser desfeita.`,
		confirmText: 'Sim, excluir',
		cancelText: 'Cancelar',
		onSuccess: () => {
			toast.success('{{entityPascal}} exclu√≠do com sucesso!')
		},
		onError: (error) => {
			toast.error(`Erro ao excluir: ${error.message}`)
		},
	})

	useHeaderConfig({
		breadcrumbs: [{ label: '{{entityPascal}}s' }],
		showSearch: true,
		createPermission: '{{entityPlural}}:create',
		newButtonLabel: 'Novo {{entityPascal}}',
		onNewClick: () => navigate('/{{routePath}}/novo'),
	})

	// Configura√ß√£o dos headers da tabela
	const headers = useMemo(
		() => [
			{
				label: 'T√≠tulo',
				field: 'title',
			},
			// TODO: Adicionar outros campos
			{
				label: 'Criado em',
				field: 'createdAt',
				type: 'date',
			},
		],
		[],
	)

	const actions = useMemo(
		() => [
			{
				label: 'Editar',
				icon: Edit,
				permission: '{{entityPlural}}:update',
				to: (row) => `/{{routePath}}/${row.id}`,
			},
			{
				label: 'Excluir',
				icon: Trash2,
				permission: '{{entityPlural}}:delete',
				variant: 'destructive',
				onClick: (row) => deleteConfirmation.confirmDelete(row),
			},
		],
		[deleteConfirmation],
	)

	const {{entityPluralCamel}} = {{entityPluralCamel}}Data?.data || []
	const rowCount = {{entityPluralCamel}}Data?.pagination?.rowCount || 0

	if (isLoading) {
		return (
			<div className="flex items-center justify-center h-96">
				<Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
			</div>
		)
	}

	return (
		<PermissionRoute permission="{{entityPlural}}:read">
			<Helmet>
				<title>{{entityPascal}}s</title>
			</Helmet>

			<div className="space-y-6 gap-4 p-4">
				{/* Header da P√°gina */}
				<div className="flex items-center justify-between">
					<div>
						<h1 className="text-3xl font-bold tracking-tight">{{entityPascal}}s</h1>
						<p className="text-muted-foreground">
							Gerencie os {{entityPlural}} do sistema
						</p>
					</div>
				</div>

				{/* Tabela */}
				<Card>
					<CardHeader>
						<CardTitle>
							Lista de {{entityPascal}}s
							{isFetching && (
								<Loader2 className="ml-2 h-4 w-4 animate-spin inline" />
							)}
						</CardTitle>
						<CardDescription>{rowCount} {{entityPlural}} cadastrados</CardDescription>
					</CardHeader>
					<CardContent className="overflow-x-auto">
						<GenericTable
							data={ {{entityPluralCamel}} }
							headers={headers}
							rowActions={actions}
							selectableRows={false}
							pagination={ {{entityPluralCamel}}Data?.pagination }
							manageUrlState={true}
						/>
					</CardContent>
				</Card>
			</div>

			{/* Dialog de confirma√ß√£o de exclus√£o */}
			<DeleteConfirmDialog {...deleteConfirmation} />
		</PermissionRoute>
	)
}

export default {{entityPascal}}Page
